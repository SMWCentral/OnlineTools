const e=document.createElement("canvas"),t=[{colorSize:{x:32,y:32},backAreaColorOffset:{x:724,y:118}},{colorSize:{x:26,y:28},backAreaColorOffset:{x:598,y:104}},{colorSize:{x:24,y:23},backAreaColorOffset:{x:539,y:86}},{colorSize:{x:18,y:19},backAreaColorOffset:{x:421,y:72}},{colorSize:{x:16,y:16},backAreaColorOffset:{x:362,y:59}}],o=16;function r(e,t,o){return t>=0&&t<e.width&&o>=0&&o<e.height}function n({data:e,width:t},o,r){const n=4*(r*t+o);return[e[n],e[n+1],e[n+2]]}function a(e,t,o,a){const[l,c,i]=n(e,t,o);for(let s=0;s<a.colorSize.y;s+=1)for(let f=0;f<a.colorSize.x;f+=1){const a=t+f,u=o+s;if(!r(e,a,u))return!1;const[d,y,g]=n(e,a,u);if(l!==d||c!==y||i!==g)return!1}return!0}function l(e,t,n,l){for(let c=0;c<o;c+=1){const o=t+c*l.colorSize.x,i=n+c*l.colorSize.y;if(!r(e,o,i))return!1;if(!a(e,o,i,l))return!1}return!0}function c(e,t,a,l){const c=new Uint8Array(768),i=function(e,t,o,a){const l=t+a.backAreaColorOffset.x,c=o+a.backAreaColorOffset.y;if(r(e,l,c))return n(e,l,c)}(e,t,a,l);let s=0;for(let r=0;r<o;r+=1)for(let f=0;f<o;f+=1){const o=t+f*l.colorSize.x,u=a+r*l.colorSize.y;let d,y,g;[d,y,g]=0===f&&null!=i?i:n(e,o,u),c[s++]=255&d,c[s++]=255&y,c[s++]=255&g}return c}function i(r){const n=r.naturalWidth,a=r.naturalHeight;e.width=n,e.height=a;const i=e.getContext("2d");i.clearRect(0,0,n,a),i.drawImage(r,0,0);const s=i.getImageData(0,0,n,a),f=function(e){for(const r of t){const t=r.colorSize.x*o,n=r.colorSize.y*o;for(let o=0;o<=e.height-n;o+=1)for(let n=0;n<=e.width-t;n+=1)if(l(e,n,o,r))return{x:n,y:o,config:r}}return{error:"Nothing in that image looks like a palette from Lunar Magic."}}(s);return null!=f.error?f:{pal:c(s,f.x,f.y,f.config)}}export default function(e){const t=e.byID("file"),r=e.byID("output"),n=e.byID("preview");let a;async function l(t){e.setStatus({message:"âŒ› Processing..."}),new Promise((e,o)=>{const r=document.createElement("img");r.src=URL.createObjectURL(t),r.onload=()=>{URL.revokeObjectURL(r.src),e(i(r))},r.onerror=e=>{URL.revokeObjectURL(r.src),o(e)}}).then(l=>{if(e.setStatus(l),null!=l.pal){const e=t.name.lastIndexOf("."),c=`${-1===e?t.name:t.name.slice(0,e)}.pal`;a={name:c,blob:new Blob([l.pal],{type:"application/octet-stream"})},r.style.display="",function(e,t){const r=e.getContext("2d"),n=r.getImageData(0,0,o,o),{data:a}=n;for(let e=0,o=0;o<t.length;e+=4,o+=3)a[e]=t[o],a[e+1]=t[o+1],a[e+2]=t[o+2],a[e+3]=255;r.putImageData(n,0,0)}(n,l.pal)}}).catch(t=>{console.log(t),e.setStatus({error:"Internal error."})})}t.addEventListener("change",()=>{const o=t.files[0];if(a=void 0,r.style.display="none",null==o)return e.setStatus({error:"No file specified."});l(o)}),e.root.addEventListener("paste",e=>{for(const o of e.clipboardData.files)o.type.startsWith("image/")&&(t.value=null,a=void 0,r.style.display="none",l(o))}),e.byID("download").addEventListener("click",()=>{null!=a&&e.download(a.name,a.blob)})}