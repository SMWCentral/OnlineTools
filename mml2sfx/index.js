let t="",e=4,a=0,n=24,s=24,r=0,o=!1;const c=/[a-g][+-]?=?[0-9]*/,i=new Map([["c",1],["d",3],["e",5],["f",6],["g",8],["a",10],["b",12]]),u=[];function g(t,e,a){return Math.max(e,Math.min(t,a))}function p(c){let p=0,d="",l="";if(c.includes("+")?p=1:c.includes("-")&&(p=-1),/[0-9]+/.test(c)){let t=parseInt(/[0-9]+/.exec(c)[0]);c.includes("=")||(t=192/t),s!==t&&(c.includes("=")?(t>127&&(u.push("⚠ Note length > $7F at "+a),t=127),l="$"+t.toString(16).padStart(2,"0")):(192%t!=0?(u.push("⚠ Invalid note length at "+a),t=Math.floor(t)):t>127&&(u.push("⚠ Note length > $7F at "+a),t=127),l="$"+t.toString(16).padStart(2,"0"))),t!==n&&(o=!1),s=t}else o||n!==s&&(l="$"+n.toString(16).padStart(2,"0"),o=!0),s=n;let h=i.get(c[0])+12*(e-1)+p+r+127;h<128?u.push("⚠ Note pitch < o1c at "+a):h>197&&u.push("⚠ Note pitch > o6a at "+a),h=g(h,128,197),d="$"+h.toString(16).padStart(2,"0"),a+=c.length-1,t+=l+d+" "}function d(t){let e=parseInt(/[0-9]+/.exec(t)[0]);t.includes("=")||(e=192/e),o=!1,n=e,a+=t.length-1}function l(t){const n=parseInt(/[0-9]+/.exec(t)[0]);n<1?u.push("⚠ Octave too low (o < 1) at "+a):n>6&&u.push("⚠ Octave too high (o > 6) at "+a),g(n,1,6),e=n,a+=t.length-1}function h(){1===e?u.push("⚠ Octave too low (o < 1) at "+a):e--}function f(){6===e?u.push("⚠ Octave too high (o > 6) at "+a):e++}function $(e){let n="$"+s.toString(16).padStart(2,"0");const r=e.match(/[0-9]+/g);for(const t of r){const e=parseInt(t);e>127?(u.push("⚠ Volume > $7F at "+a),n+="$7F"):n+="$"+e.toString(16).padStart(2,"0")}t+=n,a+=e.length-1}function b(e){let n=parseInt(/[0-9]+/.exec(e)[0]);n>127&&(u.push("⚠ Instrument > $7F at "+a),n=127),t+="$da$"+n.toString(16).padStart(2,0)+" ",a+=e.length-1}function F(n){if("dd"===n.substring(1,3))if(/\$dd\$[0-9A-Fa-f][0-9A-Fa-f]\$[0-9A-Fa-f][0-9A-Fa-f]\$[0-9A-Fa-f][0-9A-Fa-f]\$[0-9A-Fa-f][0-9A-Fa-f]/.test(n.substring(0,15))){let e=parseInt(n.substring(4,6),16)+r,s=parseInt(n.substring(7,9),16),o=parseInt(n.substring(10,12),16),c=parseInt(n.substring(13,15),16)+r;e<128&&(u.push("⚠ Pitch bend start note < o1c"),e=128),s>127&&(u.push("⚠ Pitch bend delay > $7F"),s=127),o>127&&(u.push("⚠ Pitch bend duration > $7F"),o=127),c<128&&(u.push("⚠ Pitch bend end note < o1c"),c=128),t+="$dd$"+e.toString(16).padStart(2,"0")+"$"+s.toString(16).padStart(2,"0")+"$"+o.toString(16).padStart(2,"0")+"$"+c.toString(16).padStart(2,"0"),a+=14}else if(/\$dd(<|>)*[A-Ga-g][+-]?\$[0-9A-Fa-f][0-9A-Fa-f]\$[0-9A-Fa-f][0-9A-Fa-f](<|>)*[A-Ga-g][+-]?/.test(n)){let s=0;const o=/(<|>)*[A-Ga-g][+-]?/.exec(n.substring(3));let c=parseInt(n.substring(o[0].length+4,o[0].length+6),16),p=parseInt(n.substring(o[0].length+7,o[0].length+9),16);const d=/(<|>)*[A-Ga-g][+-]?/.exec(n.substring(3+o[0].length+3+3));for(const t of o[0])"<"===t?h():">"===t&&f();s=o[0].includes("+")?1:o[0].includes("-")?-1:0;let l=i.get(o[0].replace(/[^A-Ga-g]/g,""))+12*(e-1)+s+r+127;l=g(l,128,197),t+="$dd$"+l.toString(16).padStart(2,"0"),c>127&&(u.push("⚠ Pitch bend delay > $7F"),c=127),p>127&&(u.push("⚠ Pitch bend duration > $7F"),p=127),t+="$"+c.toString(16).padStart(2,"0")+"$"+p.toString(16).padStart(2,"0");for(const t of d[0])"<"===t?h():">"===t&&f();s=d[0].includes("+")?1:d[0].includes("-")?-1:0,l=i.get(d[0].replace(/[^A-Ga-g]/g,""))+12*(e-1)+s+r+127,l=g(l,128,197),t+="$"+l.toString(16).padStart(2,"0"),a+=n.length-1}else u.push("⚠ Incorrect $DD parameters (should be 4 parameters, notes should have no lengths)."),a+=2;else if("eb"===n.substring(1,3))if(/\$eb\$[0-9A-Fa-f][0-9A-Fa-f]\$[0-9A-Fa-f][0-9A-Fa-f]\$[0-9A-Fa-f][0-9A-Fa-f]/.test(n.substring(0,12))){let e=parseInt(n.substring(4,6),16),s=parseInt(n.substring(7,9),16);const o=parseInt(n.substring(10,12),16)+r;e>127&&(u.push("⚠ Pitch bend delay > $7F"),e=127),s>127&&(u.push("⚠ Pitch bend duration > $7F"),s=127),t+="$eb$"+e.toString(16).padStart(2,"0")+"$"+s.toString(16).padStart(2,"0")+"$"+o.toString(16),a+=11}else if(/\$eb\$[0-9A-Fa-f][0-9A-Fa-f]\$[0-9A-Fa-f][0-9A-Fa-f](<|>)*[A-Ga-g][+-]?/.test(n)){let s=0,o=parseInt(n.substring(4,6),16),c=parseInt(n.substring(7,9),16);const p=n.substring(9);o>127&&(u.push("⚠ Pitch bend delay > $7F"),o=127),c>127&&(u.push("⚠ Pitch bend duration > $7F"),c=127),t+="$eb$"+o.toString(16).padStart(2,"0")+"$"+c.toString(16).padStart(2,"0");for(const t of p)"<"===t?h():">"===t&&f();s=p.includes("+")?1:p.includes("-")?-1:0;let d=i.get(p.replace(/[^A-Ga-g]/g,""))+12*(e-1)+s+r+127;d=g(d,128,197),t+="$"+d.toString(16).padStart(2,"0"),a+=n.length-1}else u.push("⚠ Too few parameters for $EB (should be 3), parameters treated separate."),a+=2;else t+=n.substring(0,3),a+=2}function A(e){let n="$da";const s=e.match(/[0-9A-Fa-f]+/g);parseInt(s[0],16)>31?(u.push("⚠ Noise pitch > $1F at "+a),n+="$9f"):(console.log(s[0]),n+="$"+(parseInt(s[0],16)+128).toString(16)),2===s.length&&(s[1]>127?(u.push("⚠ Noise instrument ref. > $7F at "+a),n+="$7f"):n+="$"+parseInt(s[1]).toString(16).padStart(2,0)),t+=n+" ",a+=e.length-1}function S(t){const e=parseInt(/-?[0-9]+/.exec(t)[0]);r=e,a+=t.length-1}export default function(i){const I=i.byID("input"),m=i.byID("convert"),v=i.byID("output"),x=i.byID("warninglist"),y=i.byID("priority");m.addEventListener("click",()=>{if(I.value.length<=1e4?(x.textContent="",t="",u.length=0,y.value&&(t+="$E0$"+parseInt(g(y.value,0,255)).toString(16).padStart(2,0)+"\n"),function(i){for(i=(i=(i=i.replace(/\s/g,"")).replace(/\n/g,"")).toLowerCase(),s=24,n=24,e=4,o=!1,a=0,r=0;a<i.length;){switch(i[a]){case"a":case"b":case"c":case"d":case"e":case"f":case"g":p(c.exec(i.substring(a))[0]);break;case"h":try{S(/h-?[0-9]+/.exec(i.substring(a))[0])}catch{u.push("⚠ Invalid h command at "+a)}break;case"l":try{d(/l=?[0-9]+/.exec(i.substring(a))[0])}catch{u.push("⚠ Invalid l command at at "+a)}break;case"o":try{l(/o[0-9]/.exec(i.substring(a))[0])}catch{u.push("⚠ Invalid o command at at "+a)}break;case"<":h();break;case">":f();break;case"v":try{$(/v[0-9]+(?:,[0-9]+)?/.exec(i.substring(a))[0])}catch{u.push("⚠ Invalid v command at at "+a)}break;case"@":try{b(/@[0-9]+/.exec(i.substring(a))[0])}catch{u.push("⚠ Invalid @ command at at "+a)}break;case"$":F(/(\$dd(<|>)*[A-Ga-g][+-]?\$[0-9A-Fa-f][0-9A-Fa-f]\$[0-9A-Fa-f][0-9A-Fa-f](<|>)*[A-Ga-g][+-]?)|(\$eb\$[0-9A-Fa-f][0-9A-Fa-f]\$[0-9A-Fa-f][0-9A-Fa-f](<|>)*[A-Ga-g][+-]?)|((\$[0-9A-Fa-f][0-9A-Fa-f])+)/.exec(i.substring(a))[0]);break;case"n":try{A(/n[0-9A-Fa-f]+(?:,[0-9A-Fa-f]+)?/.exec(i.substring(a))[0])}catch{u.push("⚠ Invalid n command at at "+a)}break;default:t+="?"}a++}}(I.value),v.value=t.toUpperCase()):(v.value="",u.push("⛔ Input length > 10000. Input not processed.")),0!==u.length){x.appendChild(document.createTextNode("Warnings:"));for(const t of u)x.appendChild(document.createElement("br")),x.appendChild(document.createTextNode(t))}})}